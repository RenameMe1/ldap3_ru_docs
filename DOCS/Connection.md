---
tags:
  - ldap3
  - python
---
# Объект Connection
Объект Connection используется для отправки запросов операций к LDAP серверу. Он может использовать разные стратегии подключения и поддерживает протокол *context manager* для автоматического открытия, [[BIND|bind]] и [[UNBIND|unbind]] подключения. ^f68bd8

##### Доступны следующие стратегии:

- **SYNC**:  Отправляется запрос и подключение ожидает до получения ответа. Вы получаете результат в значении ответа подключения. ^857f70
- **ASYNC**: Отправляется запрос и подключение немедленно возвращает *message_id*, которое может быть использовано позднее для возвращения ответа. Безопасно для многопоточных программ.
- **LDIF**: Запрос преобразуется в формат *ldif-change* и возвращается данные [[LDIF]] . 
- **RESTARTABLE**: автоматически перезапускающееся синхронное подключение. Он повторяет операцию указанное кол-во раз или бесконечно.
- **REUSABLE**: Асинхронная стратегия, которая внутренне открывает множество подключений к [[Server]] (или множеству [[Server]] через [[Server#Server Pool|ServerPool]]) каждое в разном потоке.
- **SAFE_SYNC**: Отправляется запрос и подключение ждет до получения ответа. Каждая операция возвращает кортеж из 4ех элементов: `status`, `result`, `response`, `request`. Это стратегия безопасна для многопоточных программ  ^52430d
- **SAFE_RESTARTABLE**: Отправляется запрос и подключение ждет до получения ответа. Каждая операция возвращает кортеж из 4 элементов: `status`, `result`, `response`, `request`, подключение перезагружается указанное количество раз или бесконечно если операция заканчивается неудачей. Это стратегия безопасна для многопоточных программ.  ^574f7f

>[!NOTE]
> Стратегии **[[#^52430d|SAFE_SYNC]]** и **[[#^574f7f|SAFE_RESTARTABLE]]** могут быть использованы в многопоточных программах. Каждая LDAP операция с **[[#^52430d|SAFE_SYNC]]** или **[[#^574f7f|SAFE_RESTARTABLE]]** стратегией возвращает кортеж из четырех элементов: `status`, `result`, `response` и `request`.
>
>- status: Стадии если операция была успешна.
>- result: результат операции LDAP 
>- response: ответ операции LDAP поиска
>- request: исходный запрос операции
>``` python
>from ldap3 import Server, Connection, SAFE_SYNC
server = Server('my_server')
conn = Connection(server, 'my_user', 'my_password', client_strategy=SAFE_SYNC, auto_bind=True)
status, result, response, _ = conn.search('o=test', '(objectclass=*)')  # usually you don't need the original request (4th element of the return tuple)
>```
> Стратегии **[[#^52430d|SAFE_SYNC]]** и **[[#^574f7f|SAFE_RESTARTABLE]]** могут быть использованы вместе с [[Abstract Layer]], но [[Abstract Layer]] в настоящее время не безопасен для многопоточных приложений.

> [!NOTE]
> Ленивое подключение
> 
> В ленивом подключении когда вы `open()` и `bind()` ничего не выполняется.
> Эти операции отложены до выполнения результативной LDAP операции ([[ADD|add]], [[MODIFY|modify]], [[DELETE|delete]], [[COMPARE|compare]], [[MODIFY_DN|modifyDn]], [[SEARCH|search]], [[EXTENDED|extended]]).
> Если `unbind()` выполняется все отложенные операции отменяются и ничего не отправляется по сети. Это может быть полезно, когда ваше приложение открывает соединения, не зная, требуется ли эффективная работа.

При использовании асинхронной стратегии, каждая операция возвращает немедленно *message_id*. Вы можете вызвать метод `get_response` объекта [[#^f68bd8|Connection]] для получения принятого ответа от сервера.

## Параметры Connection:

- **server**: Объект [[Server]] для установки контакта. Он может быть [[Server#Server Pool|ServerPool]]. В этом случае [[Server#Server Pool|ServerPool]] стратегия используется при открытии [[#^f68bd8|Connection]]. Вы также можете отправить строку содержащую имя сервера. В этом случае объект [[Server]] косвенно создается с стандартными параметрами.
- **user:** Учетная запись пользователя для авторизации для [[BIND#Simple bind|simple bind]] (По умолчанию None).
- **password:** Пароль пользователя для [[BIND#Simple bind|simple bind]].
- **auto_bind:** Автоматическое открытие и [[BIND|bind]] подключения. Может быть: `AUTO_BIND_NONE`, `AUTO_BIND_NO_TLS`, `AUTO_BIND_TLS_AFTER_BIND`, `AUTO_BIND_TLS_BEFORE_BIND`.
- **version:** Версия протокола LDAP (По стандарту 3)
- **authentication:** Аутентификационный метод, может быть `ANONYMOUS`, `SIMPLE`, `SASL` или `NTLM`. По стандарту `ANONYMOUS` если оба `user` и `password` имеют значение `None`, иначе по стандарту [[BIND#^9d757b|SIMPLE]].  [[BIND#^74f22c|NTLM]] использует NTMLv2 аутентификацию. Имя пользователя должно быть в формате `damain\user`.
- **client_strategy:** Стратегия общения используемая клиентом (по стандарту [[#^857f70|SYNC]])
- **auto_referrals:** Указывается если [[#^f68bd8|Connection]] должен следовать перенаправлению автоматически (по умолчанию True). Допустимые реферальные сервера указаны в объекте [[Server]].
- **sasl_mechanism:**  Указывает механизм SSL для использования при SASL аутентификации. Механизм доступен в [[BIND#External|EXTERNAL]], [[BIND#Digest-MD5|DIGEST-MD5]] (Не рекомендуется RFC из-за своей не безопасности ) и GSSAPI.
- **sasl_credential:** Объект специфичный выбранному SASL механизму. Обратитесь к документации для каждого поддерживаемого SASL механизма.
- **collect_usage:** Связывает объект ConnectionUsage с [[Connection]] для хранения метрик использования соединения 
- **read_only:** При значении `True`, подавляет [[MODIFY]], [[DELETE]], [[ADD]], [[MODIFY_DN]] (move) операции, по стандарту `False`.
- **lazy:** При значении `True`, [[Connection]] будет откладывать open и bind до запроса другой LDAP операции.
- **check_names:**  При значении `True`, имена атрибутов в утверждениях и фильтрах будут проверены по отношению к схеме ([[Server]] должен иметь загруженную схему с параметром `get_info=ALL` или `get_info=SCHEMA`) и поиск результатов будет  отформатирован так как указанно в схеме.
- **raise_exceptions:** При значении `True`, LDAP операции будут вызывать исключения (подкласс от LDAPOperationResult) если результат не один из следующих: `RESULT_SUCCESS`, `RESULT_COMPARE_FALSE`, `RESULT_COMPARE_TRUE`, `RESULT_REFERRAL`.
- **pool_name:** не обязательный идентификатор для набора [[Connection]] при использовании стратегии pooled connection
- **pool_size:** Размер пула [[Connection]] используемого в стратегии pooled connection
- **pool_lifetime:** Количество секунд перед пересоздание нового подключения в пуле при использовании стратегии pooled connection.
- **pool_keepalive:** Количество секунд для ожидания перед отправкой операции [[ABANDON|Abandon]](0) в бездействующее подключение при использовании стратегии pooled connection. Операция [[ABANDON|Abandon]](0) безвредна, использование не допустит закрытие подключения сервером.
- **fast_decoder:** При значении `False`, используется декодер `pyasn1` вместо более быстрого внешнего декодера. Дает лучшие выходные данные в расширенном логировании.
- **receive_timeout:** Переключает сокет в non-bloking мод - вызывающий исключение после указанной суммы секунд если ничего не получено в ответ.
- **return_empty_attributes:** При выполнении поиска, если атрибут пустой, то его значение устанавливается в пустой список, по стандарту `True`.
- **auto_range:**  Если сервер возвращает фиксированную сумму записей в поиске с использованием тега `range` (RFC 3866) приведите это значение к `True`, позволит библиотеке ldap3 автоматически запросить все записи с дополнительным поиском. Возвращенные записи будут как при выполнении одиночной операции поиска. 
-  **use_referral_cache:** При значении `True`, реферальные подключения закрываются не сразу, и хранятся в Кеше на случай если потребуется отправить другой запрос на этот же сервер.
- **auto_escape:** Автоматически применяет LDAP кодирования для фильтрации значений, по стандарту `True`
- **auto_encode:** Автоматически пытается преобразовать локальную кодировку к UTF8 для хорошо известного синтаксиса и типа, по стандарту `True`

>[!NOTE]
> Свойство *auto_range* невероятно полезно при операции поиска Active Directory. Когда AD поиск возвращает более 1000 записей это свойство автоматически используется сервером. Таким образом, может случиться так, что ваш код будет работать без сбоев до тех пор, пока объем ваших данных не превысит лимит в 1000 записей и ваш код не перестанет работать должным образом без какой-либо видимой причины. 

С объектом [[Connection]] вы можете выполнять все стандартные операции LDAP:

- [[BIND]]: Выполняет связь с LDAP сервером с типом аутентификации и учетными данными указанными в [[Connection]]:
	- controls: добавляет регуляторы для отправки в запросе

> [!NOTE]
> При привязке с именем пользователя из не доверенного источника (как пользователь, который ввел в его в терминале или на веб странице) вы должны выполнить `escape_rdn(username)` что бы убедиться, что входящее значение не содержит любых запретных символов. Функция `escape_rdn` находится в пространстве имен `ldap3.utils.dn`

- [[UNBIND]]: отключение и закрытие подключения:
	-  controls: добавляет регуляторы для отправки в запросе
- [[COMPARE]]:  выполнение сравнения между значениями атрибутов записи и значениями атрибутов:
	- dn: отличительное имя записи атрибуты которого сравниваются
	- attribute: имя атрибута для сравнения
	- value: Значение для сравнения
	- controls: добавляет регуляторы для отправки в запросе
- [[ADD]]: Добавляет запись в LDAP сервер. 
	- dn: отличительное имя объекта для добавления
	- object_class: Имя класса атрибута для добавления, может быть строкой содержащей одно значение или список строк.
	- attributes: Словарь в формате ` {‘attr1’: ‘val1’, ‘attr2’: ‘val2’, …}` (or `{‘attr1’: [‘val1’, ‘val2’, …], …}` для многозначных атрибутов)
	- controls: добавляет регуляторы для отправки в запросе
- [[DELETE]]: Удаление указанного объекта:
	- dn: отличительное имя объекта для удаления
	- controls: добавляет регуляторы для отправки в запросе
- [[MODIFY]]:  модификация атрибутов записи: 
	- dn: отличительное имя объекта
	- changes: Словарь в формате ` {‘attribute1’: [(operation1, [val1, val2, …])`, `(operation2, [val1, val2, …]), …]}` операций `MODIFY_ADD`, `MODIFY_DELETE`, `MODIFY_REPLACE`, `MODIFY_INCREMENT`
	- controls: добавляет регуляторы для отправки в запросе
- [[MODIFY_DN]]: Модификация относительного отличительного имени записи или выполнение перемещения записи.
	- dn: отличительное имя записи чье относительное имя должно быть модифицировано. 
	- relative_dn: новое относительно dn записи
	- delete_old_dn:  удаление предыдущего dn (по стандарту True)
	- new_superior: новый контейнер записи
	- controls: добавляет регуляторы для отправки в запросе

> [!NOTE]
> modify_dn на самом деле операция с двумя вариантами исполнения: вы можете переименовать последнюю часть dn или вы перемещаете запись в другой контейнер но вы не можете выполнить обе операции в одно и тоже время.

-  [[SEARCH]]: выполняет операцию поиска в базе данных LDAP:
	-  **search_base**: база поискового запроса
	-  **search_filter**: Фильтр поискового запроса. Он должен соответствовать синтаксису фильтра LDAP указанному в RFC4515. Если фильтр поиска содержит следующие символы вы должны использовать соответствующий escape-код ASCII последовательность, согласно RFC4515 (секция 3): `‘*’ -> ‘\2A’, ‘(’ -> ‘\28’, ‘)’ -> ‘\29’, ‘' -> ‘\5C’, chr(0) -> ‘\00’.`
	-  **search_scope**: указывает ширину контекста поиска.
		- **BASE**: Возвращает атрибуты записи указанные в `search_base`.
		- **LEVEL**: Возвращает атрибуты записи указанные в `search_base`. BASE должна ссылаться на объект контейнера.
		- **SUBTREE**: Возвращает атрибуты записи указанные в `search_base` и все вниз зависимые контейнеры.
	- **dereference_aliases**: Указывает как сервер должен обрабатывать ссылки других записей.
		- **DEREF_NEVER**:
		- **DEREF_SEARCH**:
		- **DEREF_BASE**:
		- **DEREF_ALWAYS**:
	- **attributes:**
	- **size_limit**
	- **time_limit**
	- **types_only**
	- **get_operational_attributes:**
	- **controls:**
	- **paged_size:**
	- **paged_criticality:**
	- **paged_cookie:**